<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.23 (Pod::Simple 3.10, Perl::Tidy 20101217) on 2010-12-21 21:10:25 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2010 Perl Advent Calendar: Four Naughty Tweeting Birds</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="20.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2010-12</a>-20++</h1>
<h2 align="center">Four Naughty Tweeting Birds</h2>
<h3 align="center">by William 'n1vux' Ricker</h3>
<p>These days, Glug the elf can mostly fill the Naughty by trolling FaceBook and MySpace. However, some sneaky naughties hide their naughty words elsewhere on-line. To catch <a href="http://questionablecontent.net/view.php?comic=1818">naughty hipsters in Northampton</a> swearing and the like on their Twitter accounts, Glug logs into his Twitter identity <a href="https://twitter.com/angrysantaelf">@AngrySantaElf</a> with his command-line twitter backup-archival tool, <tt>teewt.pl</tt>. (He thinks spelling Tweet backwards for a backup script is hilarious.)</p>
<p>Glug downloaded this useful little backup script off some website site and hacked it a little to download other peoples tweets instead of one's own precious drivel. It used <tt><a href="http://search.cpan.org/perldoc?Net::Twitter::Lite" title="Net::Twitter::Lite">Net::Twitter::Lite</a></tt><sup><a href="#footnote_moose">1</a></sup>which provides both OAuth authentication for Twitter and Basic (insecure passwords) for Identi.ca, Laconi.ca, etc. So the first time he runs it as a test, it requires he log into the web Twitter to get the authentication Pin for this app, which it stores in <tt>teewt.dat</tt>.</p>
<pre><span class="c">$ perl teewt.pl last=angrysantaelf
 Authorize this application at: http://twitter.com/oauth/authorize?oauth_token=LKzNrr...
Then, enter the PIN# provided to continue: 
123456

$VAR1 = [
          {
            'source' => 'web',
            'retweet_count' => 0,
            'created_at' => 'Mon Dec 20 22:56:04 +0000 2010',
            'text' => 'Turns out our Slinky Dogs are rabid, so open those Christmas gifts with great care and distance.',
            'in_reply_to_user_id' => undef,
            'user' => {
                        'id' => 214624407,
                        'screen_name' => 'angrysantaelf',
...</span></pre>
<p>After that, Glug grabs the last 500 tweets for each NoHo hipster</p>
<pre><span class="c">$ perl teewt.pl PAGES=5 user=hanneloreEC user=tai_fighter user=martenreed  user=marigoldfarmer user=fayewhitaker user=dorabianchi > noho.csv
fetching page 1 ...
... got 100 
fetching page 2 ...
... got 100</span></pre>
<p>And then counts the officially sanctioned dirty words<sup><a href="#footnote_filthy">2</a></sup> and average swears per tweet per person.<sup><a href="#footnote_censor">3</a></sup></p>
<pre><span class="c">$ perl -I. -MRE_BadWords -F,  -lane '$c{$F[1]}++; $n{$F[1]}++ while $F[4] =~ m/$BadWords/g;' \
>	-e 'END{printf "%d\t%d\t%.3f\t%s\n",$n{$_} , $c{$_}, $n{$_} / $c{$_}, $_  
>		for sort keys %n }' noho.csv 
6	210	0.029	dorabianchi
16	250	0.064	fayewhitaker
1	377	0.003	hanneloreEC
7	118	0.059	marigoldfarmer
10	200	0.050	martenreed
10	136	0.074	tai_fighter</span></pre>
<p>Glug sees four naughty tweeting birds over the 5% badword line, and gives them each a Naughty demerit. He also gives Hannelore a Nice check for being much much cleaner than her bad influence friends. (Dora will get a demerit too, when Glug finds out what she's <span style="font-style: italic">done</span> but that's not on-line.)</p>
<a name="teewt.pl" id="teewt.pl"></a><h2><a href="teewt.pl">teewt.pl</a></h2><pre>
<a name="teewt.pl.1"></a>   1 #!perl -l
<a name="teewt.pl.2"></a>   2 <span class="c">#</span>
<a name="teewt.pl.3"></a>   3 <span class="c"># teewt - backing tweets to CSV or, singly, as Dumper object</span>
<a name="teewt.pl.4"></a>   4 <span class="c"># </span>
<a name="teewt.pl.5"></a>   5 <span class="c"># derived from Net::Twitter::Lite - OAuth desktop app example</span>
<a name="teewt.pl.6"></a>   6 <span class="c"># by William Ricker for Perl Advent Calendar 2010</span>
<a name="teewt.pl.7"></a>   7 <span class="c"># Copyright 2010 William Ricker</span>
<a name="teewt.pl.8"></a>   8 <span class="c"># License Same As Perl</span>
<a name="teewt.pl.9"></a>   9 
<a name="teewt.pl.10"></a>  10 <span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
<a name="teewt.pl.11"></a>  11 <span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<a name="teewt.pl.12"></a>  12 
<a name="teewt.pl.13"></a>  13 <span class="k">use</span> <span class="w">Net::Twitter::Lite</span><span class="sc">;</span>
<a name="teewt.pl.14"></a>  14 <span class="k">use</span> <span class="w">File::Spec</span><span class="sc">;</span>
<a name="teewt.pl.15"></a>  15 <span class="k">use</span> <span class="w">Storable</span><span class="sc">;</span>
<a name="teewt.pl.16"></a>  16 <span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<a name="teewt.pl.17"></a>  17 <span class="k">use</span> <span class="w">Text::CSV</span><span class="sc">;</span>
<a name="teewt.pl.18"></a>  18 <span class="k">use</span> <span class="w">IO::Wrap</span><span class="sc">;</span> <span class="c"># wraphandle STDOUT</span>
<a name="teewt.pl.19"></a>  19 <span class="k">use</span> <span class="w">feature</span> <span class="q">&quot;:5.10&quot;</span><span class="sc">;</span>
<a name="teewt.pl.20"></a>  20 
<a name="teewt.pl.21"></a>  21 <span class="c"># Setup</span>
<a name="teewt.pl.22"></a>  22 
<a name="teewt.pl.23"></a>  23 <span class="k">my</span> <span class="i">$nt</span> = <span class="i">authorize</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.24"></a>  24 
<a name="teewt.pl.25"></a>  25 <span class="c"># Supported Twitter API calls (methods) and columns to export in CSV</span>
<a name="teewt.pl.26"></a>  26 <span class="k">my</span> <span class="i">%Fetches</span> = <span class="s">(</span>
<a name="teewt.pl.27"></a>  27 	<span class="q">&#39;sent_direct_messages&#39;</span> <span class="cm">=&gt;</span>
<a name="teewt.pl.28"></a>  28                 <span class="s">[</span> <span class="q">qw[ id_str created_at sender_screen_name recipient_screen_name text ]</span><span class="s">]</span><span class="cm">,</span>
<a name="teewt.pl.29"></a>  29         <span class="q">&#39;direct_messages&#39;</span> <span class="cm">=&gt;</span>
<a name="teewt.pl.30"></a>  30                 <span class="s">[</span> <span class="q">qw[ id_str created_at sender_screen_name recipient_screen_name text ]</span><span class="s">]</span><span class="cm">,</span>
<a name="teewt.pl.31"></a>  31        <span class="q">&#39;user_timeline&#39;</span> <span class="cm">=&gt;</span>
<a name="teewt.pl.32"></a>  32                 <span class="s">[</span><span class="q">qw[ created_at user/screen_name user/name user/id_str </span>
<a name="teewt.pl.33"></a>  33 			<span class="q">text geo coordinates place id_str source</span>
<a name="teewt.pl.34"></a>  34                       <span class="q">in_reply_to_status_id_str in_reply_to_screen_name retweet_count ]</span><span class="s">]</span><span class="cm">,</span>
<a name="teewt.pl.35"></a>  35 	<span class="q">&#39;friends_timeline&#39;</span> <span class="cm">=&gt;</span>
<a name="teewt.pl.36"></a>  36                 <span class="s">[</span><span class="q">qw[ created_at user/screen_name user/name user/id_str </span>
<a name="teewt.pl.37"></a>  37 		<span class="q">text geo coordinates place id_str</span>
<a name="teewt.pl.38"></a>  38 		<span class="q">in_reply_to_status_id_str in_reply_to_screen_name retweet_count ]</span><span class="s">]</span><span class="cm">,</span>
<a name="teewt.pl.39"></a>  39 <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.40"></a>  40 
<a name="teewt.pl.41"></a>  41 <span class="k">my</span> <span class="i">%Short</span> = <span class="s">(</span>
<a name="teewt.pl.42"></a>  42 	<span class="w">sdms</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;sent_direct_messages&#39;</span><span class="cm">,</span> <span class="w">all</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.43"></a>  43 	<span class="w">dms</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;direct_messages&#39;</span><span class="cm">,</span> <span class="w">all</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.44"></a>  44 	<span class="w">mine</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;user_timeline&#39;</span><span class="cm">,</span><span class="w">all</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.45"></a>  45 	<span class="w">status</span> <span class="cm">=&gt;</span>  <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;user_timeline&#39;</span><span class="cm">,</span><span class="w">one</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.46"></a>  46 	<span class="w">friends</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;friends_timeline&#39;</span><span class="cm">,</span><span class="w">all</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.47"></a>  47 	<span class="q">&#39;last&#39;</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;friends_timeline&#39;</span><span class="cm">,</span><span class="w">one</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.48"></a>  48 	<span class="w">sd1</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;sent_direct_messages&#39;</span><span class="cm">,</span> <span class="w">one</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.49"></a>  49 	<span class="w">dm1</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="w">cmd</span><span class="cm">=&gt;</span><span class="q">&#39;direct_messages&#39;</span><span class="cm">,</span> <span class="w">one</span><span class="cm">=&gt;</span><span class="n">1</span><span class="s">}</span><span class="cm">,</span>
<a name="teewt.pl.50"></a>  50 <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.51"></a>  51 
<a name="teewt.pl.52"></a>  52 <span class="c"># Work - look for commands on @ARGV</span>
<a name="teewt.pl.53"></a>  53 
<a name="teewt.pl.54"></a>  54 <span class="k">my</span> <span class="i">$pages</span> = <span class="i">$ENV</span>{<span class="w">PAGES</span>} || <span class="n">50</span><span class="sc">;</span>
<a name="teewt.pl.55"></a>  55 
<a name="teewt.pl.56"></a>  56 <span class="k">while</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$cmd</span> = <span class="k">shift</span> <span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.57"></a>  57     <span class="k">given</span> <span class="s">(</span><span class="i">$cmd</span><span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.58"></a>  58 
<a name="teewt.pl.59"></a>  59 	<span class="k">when</span> <span class="s">(</span><span class="q">/PAGES=(\d+)/</span><span class="s">)</span> <span class="s">{</span><span class="i">$pages</span> = <span class="i">$1</span><span class="sc">;</span><span class="s">}</span>
<a name="teewt.pl.60"></a>  60 
<a name="teewt.pl.61"></a>  61 	<span class="k">when</span> <span class="s">(</span><span class="i">%Fetches</span><span class="s">)</span><span class="s">{</span> <span class="i">all</span><span class="s">(</span><span class="i">$cmd</span><span class="s">)</span><span class="s">}</span> 
<a name="teewt.pl.62"></a>  62 
<a name="teewt.pl.63"></a>  63 	<span class="k">when</span> <span class="s">(</span><span class="i">%Short</span><span class="s">)</span><span class="s">{</span>
<a name="teewt.pl.64"></a>  64 		<span class="k">my</span> <span class="s">(</span><span class="i">$cmdLong</span><span class="cm">,</span><span class="i">$one</span><span class="cm">,</span><span class="i">$all</span><span class="s">)</span> = <span class="i">@</span>{<span class="i">$Short</span>{<span class="i">$cmd</span>}}{<span class="q">qw[cmd one all]</span>}<span class="sc">;</span>
<a name="teewt.pl.65"></a>  65 		<span class="c"># hash slice per http://www.stonehenge.com/merlyn/UnixReview/col68.html </span>
<a name="teewt.pl.66"></a>  66  		<span class="i">once</span><span class="s">(</span><span class="i">$cmdLong</span><span class="s">)</span> <span class="k">if</span> <span class="i">$one</span><span class="sc">;</span>
<a name="teewt.pl.67"></a>  67 		<span class="i">all</span><span class="s">(</span><span class="i">$cmdLong</span><span class="s">)</span> <span class="k">if</span> <span class="i">$all</span><span class="sc">;</span>
<a name="teewt.pl.68"></a>  68 	<span class="s">}</span>
<a name="teewt.pl.69"></a>  69 
<a name="teewt.pl.70"></a>  70 	<span class="c"># last_$cmd is just one</span>
<a name="teewt.pl.71"></a>  71 	<span class="k">when</span> <span class="s">(</span> <span class="q">/ ^ last_ (\w+) (?(?{$Fetches{$1}})(?-:)|(*FAIL)) $ /xi</span> <span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.72"></a>  72 	   <span class="i">once</span><span class="s">(</span><span class="i">$1</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.73"></a>  73 	<span class="s">}</span>
<a name="teewt.pl.74"></a>  74 
<a name="teewt.pl.75"></a>  75 	<span class="c"># alias - drop a final s and the last_ is optional</span>
<a name="teewt.pl.76"></a>  76 	<span class="k">when</span> <span class="s">(</span> <span class="q">/ ^ (?: last_ )? (\w+) (?(?{$Fetches{$1.q(s)}})(?-:)|(*FAIL)) $ /xi</span> <span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.77"></a>  77 	   <span class="i">once</span><span class="s">(</span><span class="i">$1</span>.<span class="q">q(s)</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.78"></a>  78 	<span class="s">}</span>
<a name="teewt.pl.79"></a>  79 
<a name="teewt.pl.80"></a>  80 	<span class="k">when</span> <span class="s">(</span> <span class="q">/ ^ last = (?: (\d+) | (\w+) ) /xi</span> <span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.81"></a>  81 	   <span class="i">once</span><span class="s">(</span><span class="q">&#39;user_timeline&#39;</span><span class="cm">,</span> <span class="s">{</span><span class="w">screen_name</span> <span class="cm">=&gt;</span> <span class="i">$2</span><span class="s">}</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$2</span><span class="sc">;</span>
<a name="teewt.pl.82"></a>  82 	   <span class="i">once</span><span class="s">(</span><span class="q">&#39;user_timeline&#39;</span><span class="cm">,</span> <span class="s">{</span><span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$1</span><span class="s">}</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$1</span><span class="sc">;</span>
<a name="teewt.pl.83"></a>  83 
<a name="teewt.pl.84"></a>  84 	<span class="s">}</span>
<a name="teewt.pl.85"></a>  85 
<a name="teewt.pl.86"></a>  86 	<span class="k">when</span> <span class="s">(</span> <span class="q">/ ^ user = (?: (\d+) | (\w+) ) /xi</span> <span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.87"></a>  87 	   <span class="i">all</span><span class="s">(</span><span class="q">&#39;user_timeline&#39;</span><span class="cm">,</span> <span class="s">{</span><span class="w">screen_name</span> <span class="cm">=&gt;</span> <span class="i">$2</span><span class="s">}</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$2</span><span class="sc">;</span>
<a name="teewt.pl.88"></a>  88 	   <span class="i">all</span><span class="s">(</span><span class="q">&#39;user_timeline&#39;</span><span class="cm">,</span> <span class="s">{</span><span class="w">id</span> <span class="cm">=&gt;</span> <span class="i">$1</span><span class="s">}</span> <span class="s">)</span> <span class="k">if</span> <span class="i">$1</span><span class="sc">;</span>
<a name="teewt.pl.89"></a>  89 
<a name="teewt.pl.90"></a>  90 	<span class="s">}</span>
<a name="teewt.pl.91"></a>  91 
<a name="teewt.pl.92"></a>  92 	<span class="i">default</span> <span class="s">{</span>
<a name="teewt.pl.93"></a>  93 		<span class="k">warn</span> <span class="q">&quot;Unrecognized command $cmd \n supported choices:\n&quot;</span><span class="sc">;</span>
<a name="teewt.pl.94"></a>  94 		<span class="k">warn</span> <span class="q">&quot;last_$_ $_ \n&quot;</span> <span class="k">for</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%Fetches</span> <span class="sc">;</span>
<a name="teewt.pl.95"></a>  95 		<span class="k">warn</span> <span class="q">&quot;abbrevs: &quot;</span>.<span class="k">join</span><span class="s">(</span><span class="q">q( )</span><span class="cm">,</span><span class="k">sort</span> <span class="k">keys</span> <span class="i">%Short</span> <span class="s">)</span>.<span class="q">&quot;\n&quot;</span><span class="sc">;</span>
<a name="teewt.pl.96"></a>  96 		<span class="k">last</span><span class="sc">;</span>
<a name="teewt.pl.97"></a>  97 	<span class="s">}</span>
<a name="teewt.pl.98"></a>  98     <span class="s">}</span>    <span class="c"># end given cmd</span>
<a name="teewt.pl.99"></a>  99 <span class="s">}</span>    <span class="c"># end cmds</span>
<a name="teewt.pl.100"></a> 100 
<a name="teewt.pl.101"></a> 101 <span class="c"># ------------------ subs -------------------------</span>
<a name="teewt.pl.102"></a> 102 
<a name="once"></a> 103 <span class="k">sub </span><span class="m">once</span> <span class="s">{</span>
<a name="teewt.pl.104"></a> 104     <span class="k">my</span> <span class="s">(</span><span class="i">$meth</span><span class="cm">,</span> <span class="i">$args</span><span class="s">)</span> = <span class="i">@_</span> <span class="sc">;</span>
<a name="teewt.pl.105"></a> 105    <span class="k">my</span> <span class="i">%args</span> = <span class="i">$args</span> ? <span class="i">%</span>{<span class="i">$args</span>} <span class="co">:</span> <span class="s">(</span><span class="s">)</span> <span class="sc">;</span> <span class="c">#=(screen_name =&gt; &#39;safety&#39; | id =&gt; 123456 );</span>
<a name="teewt.pl.106"></a> 106  
<a name="teewt.pl.107"></a> 107 	<span class="c">#TBD should probably be in eval catch too ?</span>
<a name="teewt.pl.108"></a> 108     <span class="k">my</span> <span class="i">$status</span> = <span class="i">$nt</span><span class="i">-&gt;$meth</span><span class="s">(</span> <span class="s">{</span> <span class="w">count</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span> <span class="i">%args</span> <span class="s">}</span> <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.109"></a> 109     <span class="k">print</span> <span class="i">Dumper</span> <span class="i">$status</span><span class="sc">;</span>
<a name="teewt.pl.110"></a> 110 <span class="s">}</span>
<a name="teewt.pl.111"></a> 111 
<a name="all"></a> 112 <span class="k">sub </span><span class="m">all</span> <span class="s">{</span>
<a name="teewt.pl.113"></a> 113     <span class="k">my</span> <span class="s">(</span><span class="i">$meth</span><span class="cm">,</span> <span class="i">$args</span><span class="s">)</span> = <span class="i">@_</span> <span class="sc">;</span>
<a name="teewt.pl.114"></a> 114 	<span class="c"># %Fetches is implicit arg</span>
<a name="teewt.pl.115"></a> 115     <span class="k">my</span> <span class="i">@Fields</span> =  <span class="i">@</span>{<span class="i">$Fetches</span>{<span class="i">$meth</span>}}<span class="sc">;</span>
<a name="teewt.pl.116"></a> 116 
<a name="teewt.pl.117"></a> 117     <span class="k">my</span>  <span class="i">$csv</span> = <span class="w">Text::CSV</span><span class="w">-&gt;new</span> <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.118"></a> 118     <span class="k">my</span> <span class="i">$io</span> = <span class="i">wraphandle</span><span class="s">(</span><span class="q">&quot;STDOUT&quot;</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.119"></a> 119 
<a name="teewt.pl.120"></a> 120     <span class="c"># setup</span>
<a name="teewt.pl.121"></a> 121     <span class="i">$csv</span><span class="i">-&gt;print</span> <span class="s">(</span><span class="i">$io</span><span class="cm">,</span> \<span class="i">@Fields</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.122"></a> 122     <span class="i">@Fields</span> = <span class="k">map</span> <span class="s">{</span> <span class="q">m((\w+)/(\w+))</span> ? <span class="s">[</span><span class="i">$1</span><span class="cm">,</span> <span class="i">$2</span><span class="s">]</span> <span class="co">:</span> <span class="i">$_</span> <span class="s">}</span> <span class="i">@Fields</span><span class="sc">;</span>
<a name="teewt.pl.123"></a> 123 	<span class="c"># expand &#39;user/screen_name&#39; to qw[user screen_name] </span>
<a name="teewt.pl.124"></a> 124 	<span class="c"># (avoids splitting in inner loop)</span>
<a name="teewt.pl.125"></a> 125 
<a name="teewt.pl.126"></a> 126     <span class="k">my</span> <span class="i">%args</span> = <span class="i">$args</span> ? <span class="i">%</span>{<span class="i">$args</span>} <span class="co">:</span> <span class="s">(</span><span class="s">)</span> <span class="sc">;</span> <span class="c">#=(screen_name =&gt; &#39;safety&#39; | id =&gt; 123456 );</span>
<a name="teewt.pl.127"></a> 127 
<a name="teewt.pl.128"></a> 128     <span class="k">for</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span> <span class="n">1</span> .. <span class="i">$pages</span> <span class="s">)</span>    <span class="c"># current 3200 max total fetch, so 50 pages enough</span>
<a name="teewt.pl.129"></a> 129     <span class="s">{</span>
<a name="teewt.pl.130"></a> 130         <span class="k">warn</span> <span class="q">&quot;fetching page $i ...\n&quot;</span><span class="sc">;</span> <span class="c"># heartbeat</span>
<a name="teewt.pl.131"></a> 131 
<a name="teewt.pl.132"></a> 132  	<span class="k">my</span> <span class="i">$statuses</span><span class="sc">;</span> 
<a name="teewt.pl.133"></a> 133         <span class="k">eval</span> <span class="s">{</span>
<a name="teewt.pl.134"></a> 134            <span class="i">$statuses</span> = <span class="i">$nt</span><span class="i">-&gt;$meth</span><span class="s">(</span>
<a name="teewt.pl.135"></a> 135                 <span class="s">{</span>
<a name="teewt.pl.136"></a> 136 
<a name="teewt.pl.137"></a> 137                     <span class="c"># id =&gt; $friendId, # for others, on user_timeline</span>
<a name="teewt.pl.138"></a> 138                     <span class="c"># since_id =&gt; $high_water, to filter already seen, on most</span>
<a name="teewt.pl.139"></a> 139                     <span class="w">count</span> <span class="cm">=&gt;</span> <span class="n">100</span><span class="cm">,</span>    <span class="c"># typically 70..80 returned</span>
<a name="teewt.pl.140"></a> 140                     <span class="w">page</span>  <span class="cm">=&gt;</span> <span class="i">$i</span><span class="cm">,</span>     <span class="c"># from 1..</span>
<a name="teewt.pl.141"></a> 141 			<span class="i">%args</span><span class="cm">,</span>
<a name="teewt.pl.142"></a> 142                 <span class="s">}</span>
<a name="teewt.pl.143"></a> 143             <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.144"></a> 144         <span class="s">}</span><span class="sc">;</span>    <span class="c"># end eval</span>
<a name="teewt.pl.145"></a> 145 
<a name="teewt.pl.146"></a> 146         <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.147"></a> 147             <span class="k">my</span> <span class="i">$Err</span> = <span class="i">$@</span><span class="sc">;</span>
<a name="teewt.pl.148"></a> 148             <span class="k">warn</span> <span class="q">&quot;$Err \n&quot;</span><span class="sc">;</span>
<a name="teewt.pl.149"></a> 149             <span class="k">given</span> <span class="s">(</span><span class="i">$Err</span><span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.150"></a> 150                 <span class="k">when</span> <span class="s">(</span><span class="q">/502|503/</span><span class="s">)</span> <span class="s">{</span> <span class="k">sleep</span> <span class="n">1</span><span class="sc">;</span> <span class="k">redo</span> <span class="s">}</span><span class="sc">;</span>    <span class="c"># the intertubes were clogged</span>
<a name="teewt.pl.151"></a> 151                 <span class="i">default</span> <span class="s">{</span> <span class="k">die</span> <span class="q">&quot;Unexpected error $Err \n&quot;</span> <span class="s">}</span><span class="sc">;</span>
<a name="teewt.pl.152"></a> 152             <span class="s">}</span>
<a name="teewt.pl.153"></a> 153         <span class="s">}</span>    <span class="c"># end if err</span>
<a name="teewt.pl.154"></a> 154         <span class="k">my</span> <span class="i">$ni</span> = <span class="k">scalar</span> <span class="i">@$statuses</span><span class="sc">;</span>
<a name="teewt.pl.155"></a> 155         <span class="k">warn</span> <span class="q">&quot;... got $ni \n&quot;</span><span class="sc">;</span> <span class="c"># heartbeat</span>
<a name="teewt.pl.156"></a> 156         <span class="k">last</span> <span class="k">unless</span> <span class="i">$ni</span><span class="sc">;</span>
<a name="teewt.pl.157"></a> 157         <span class="k">for</span> <span class="k">my</span> <span class="i">$status</span> <span class="s">(</span><span class="i">@$statuses</span><span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.158"></a> 158               <span class="i">$csv</span><span class="i">-&gt;print</span> <span class="s">(</span><span class="i">$io</span><span class="cm">,</span> 
<a name="teewt.pl.159"></a> 159 			<span class="s">[</span> <span class="k">map</span> <span class="s">{</span><span class="s">(</span> <span class="k">ref</span> <span class="i">$_</span> 
<a name="teewt.pl.160"></a> 160 				? <span class="i">$status</span>-&gt;{<span class="i">$_</span>-&gt;[<span class="n">0</span>]}-&gt;{<span class="i">$_</span>-&gt;[<span class="n">1</span>]} // <span class="q">&quot;&quot;</span> <span class="c">#/</span>
<a name="teewt.pl.161"></a> 161 				<span class="co">:</span>   <span class="i">$status</span>-&gt;{<span class="i">$_</span>} // <span class="q">&quot;&quot;</span> <span class="c">#/</span>
<a name="teewt.pl.162"></a> 162 				<span class="s">)</span> <span class="s">}</span>  <span class="i">@Fields</span>
<a name="teewt.pl.163"></a> 163 			<span class="s">]</span> <span class="s">)</span> <span class="sc">;</span>
<a name="teewt.pl.164"></a> 164         <span class="s">}</span> <span class="c">#end for each</span>
<a name="teewt.pl.165"></a> 165     <span class="s">}</span>    <span class="c"># end page i</span>
<a name="teewt.pl.166"></a> 166 <span class="s">}</span>    <span class="c"># end sub all</span>
<a name="teewt.pl.167"></a> 167 
<a name="authorize"></a> 168 <span class="k">sub </span><span class="m">authorize</span> <span class="s">{</span>
<a name="teewt.pl.169"></a> 169 
<a name="teewt.pl.170"></a> 170     <span class="c"># straight from Net-Twitter-Lite&#39;s examples/oauth_desktop.pl</span>
<a name="teewt.pl.171"></a> 171     <span class="c"># just put into sub</span>
<a name="teewt.pl.172"></a> 172     
<a name="teewt.pl.173"></a> 173     <span class="c"># You can replace the consumer tokens with your own;</span>
<a name="teewt.pl.174"></a> 174     <span class="c"># these tokens are for the Net::Twitter example app.</span>
<a name="teewt.pl.175"></a> 175     <span class="k">my</span> <span class="i">%consumer_tokens</span> = <span class="s">(</span>
<a name="teewt.pl.176"></a> 176         <span class="w">consumer_key</span>    <span class="cm">=&gt;</span> <span class="q">&#39;v8t3JILkStylbgnxGLOQ&#39;</span><span class="cm">,</span>
<a name="teewt.pl.177"></a> 177         <span class="w">consumer_secret</span> <span class="cm">=&gt;</span> <span class="q">&#39;5r31rSMc0NPtBpHcK8MvnCLg2oAyFLx5eGOMkXM&#39;</span><span class="cm">,</span>
<a name="teewt.pl.178"></a> 178     <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.179"></a> 179 
<a name="teewt.pl.180"></a> 180     <span class="c"># $datafile = oauth_desktop.dat</span>
<a name="teewt.pl.181"></a> 181     <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$datafile</span> <span class="s">)</span> = <span class="w">File::Spec</span><span class="w">-&gt;splitpath</span><span class="s">(</span><span class="i">$0</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.182"></a> 182     <span class="i">$datafile</span> =~ <span class="q">s/\..*/.dat/</span><span class="sc">;</span>
<a name="teewt.pl.183"></a> 183 
<a name="teewt.pl.184"></a> 184     <span class="k">my</span> <span class="i">$nt</span> = <span class="w">Net::Twitter::Lite</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">%consumer_tokens</span><span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.185"></a> 185     <span class="k">my</span> <span class="i">$access_tokens</span> = <span class="k">eval</span> <span class="s">{</span> <span class="i">retrieve</span><span class="s">(</span><span class="i">$datafile</span><span class="s">)</span> <span class="s">}</span> || <span class="s">[</span><span class="s">]</span><span class="sc">;</span>
<a name="teewt.pl.186"></a> 186 
<a name="teewt.pl.187"></a> 187     <span class="k">if</span> <span class="s">(</span><span class="i">@$access_tokens</span><span class="s">)</span> <span class="s">{</span>
<a name="teewt.pl.188"></a> 188         <span class="i">$nt</span><span class="i">-&gt;access_token</span><span class="s">(</span> <span class="i">$access_tokens</span>-&gt;[<span class="n">0</span>] <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.189"></a> 189         <span class="i">$nt</span><span class="i">-&gt;access_token_secret</span><span class="s">(</span> <span class="i">$access_tokens</span>-&gt;[<span class="n">1</span>] <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.190"></a> 190     <span class="s">}</span>
<a name="teewt.pl.191"></a> 191     <span class="k">else</span> <span class="s">{</span>
<a name="teewt.pl.192"></a> 192         <span class="k">my</span> <span class="i">$auth_url</span> = <span class="i">$nt</span><span class="i">-&gt;get_authorization_url</span><span class="sc">;</span>
<a name="teewt.pl.193"></a> 193         <span class="k">print</span> <span class="q">&quot; Authorize this application at: $auth_url\n&quot;</span>
<a name="teewt.pl.194"></a> 194 		. <span class="q">&quot;Then, enter the PIN# provided to continue: &quot;</span><span class="sc">;</span>
<a name="teewt.pl.195"></a> 195 
<a name="teewt.pl.196"></a> 196         <span class="k">my</span> <span class="i">$pin</span> = <span class="q">&lt;STDIN&gt;</span><span class="sc">;</span>    <span class="c"># wait for input</span>
<a name="teewt.pl.197"></a> 197         <span class="k">chomp</span> <span class="i">$pin</span><span class="sc">;</span>
<a name="teewt.pl.198"></a> 198 
<a name="teewt.pl.199"></a> 199         <span class="c"># request_access_token stores the tokens in $nt AND returns them</span>
<a name="teewt.pl.200"></a> 200         <span class="k">my</span> <span class="i">@access_tokens</span> = <span class="i">$nt</span><span class="i">-&gt;request_access_token</span><span class="s">(</span> <span class="w">verifier</span> <span class="cm">=&gt;</span> <span class="i">$pin</span> <span class="s">)</span><span class="sc">;</span>
<a name="teewt.pl.201"></a> 201 
<a name="teewt.pl.202"></a> 202         <span class="c"># save the access tokens</span>
<a name="teewt.pl.203"></a> 203         <span class="w">store</span> \<span class="i">@access_tokens</span><span class="cm">,</span> <span class="i">$datafile</span><span class="sc">;</span>
<a name="teewt.pl.204"></a> 204     <span class="s">}</span>
<a name="teewt.pl.205"></a> 205 
<a name="teewt.pl.206"></a> 206     <span class="k">return</span> <span class="i">$nt</span><span class="sc">;</span>
<a name="teewt.pl.207"></a> 207 <span class="s">}</span>
<a name="teewt.pl.208"></a> 208 
</pre>
<p><a name="footnote_moose" id="footnote_moose"></a>1. <tt><a href="http://search.cpan.org/perldoc?Net::Twitter" title="Net::Twitter">Net::Twitter</a></tt> has more HTML and Error handling bells-and-whistles for those with the Moose in the house, worthwhile for Web-App use, but not needed for command-line/desktop use.<br>
</p>
<p><a name="footnote_filthy" id="footnote_filthy"></a>2. <a href="http://en.wikipedia.org/wiki/Seven_dirty_words">George Carlin's Seven Filthy Words</a> aka The Seven Words You Can't Say on the Radio as <a href="http://en.wikisource.org/wiki/F.C.C._v._Pacifica_Foundation">heard by Supreme Court of the US</a><br>
</p>
<p><a name="footnote_censor" id="footnote_censor"></a>3. In the interests of decency, we are ignoring the two worst potty-mouth twitters of the NoHo QC storyline. Glug the Elf since doesn't believe in talking birds so skips Yelling Bird, and the subjects' pintsize robot friend, a known hentai smut linker, is not a natural fictional person so is ineligible. Neither even gets coal, so Glug doesn't search them. Well, maybe he does, but not for $DayJob.<br>
</p>
<div style="float: right; font-size: 10pt"><a href="20.pod">View Source (POD)</a></div><br />
</body>
</html>
